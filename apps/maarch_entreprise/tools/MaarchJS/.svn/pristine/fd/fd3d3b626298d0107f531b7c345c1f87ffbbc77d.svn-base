Maarch.treeview={Tree:Class.create({_DEFAULT_OPTIONS:{treeId:"MaarchTree",treeLabel:"MaarchTree","img.path":"img/","img.mt_fopened":"folderopen.gif","img.mt_fclosed":"folder.gif","img.mt_plus":"plus0.gif","img.mt_minus":"minus0.gif","img.mt_none":"none.gif",initial_structure:null},_setOptions:function(a){var b=this._DEFAULT_OPTIONS;$H(this._DEFAULT_OPTIONS).keys().intersect($H(a).keys()).each(function(c){b[c]=a[c]});this.options=b},initialize:function(a,b){this.root=$(a).addClassName("MaarchTreeRoot");
this._setOptions(b);Maarch.AddIEDiv(this.root);Maarch.injectInlineCSS(".MaarchTreeRoot li:last-child {    background-image: url("+this.options["img.path"]+"line2.gif);}.MaarchTreeRoot li {    background-image: url("+this.options["img.path"]+"line3.gif);}#IE6 .MaarchTreeRoot li, #IE7 .MaarchTreeRoot li {    background-color: inherit;    background-image: expression((this.nextSibling==null) ? 'url("+this.options["img.path"]+"line2.gif)' : 'url("+this.options["img.path"]+"line3.gif)');}");this.prefix=
"mt_"+this.root.id+"_";if(this.options.initial_structure){this.insertBranches(this.options.initial_structure,this.root);this.options.initial_structure=null}else this._formatUL(this.root);this._setEventObserver()},getBranchById:function(a){return $(a)},hasChild:function(a){return $(a).down("li")?true:false},expand:function(a){a=$(a);a.removeClassName("mt_closed");a.addClassName("mt_opened");this.hasChild(a)||a.addClassName("mt_leaf");return a},collapse:function(a){a=$(a);a.removeClassName("mt_opened");
a.addClassName("mt_closed");return a},toggle:function(a){var b=$(a);b.hasClassName("mt_opened");this[b.hasClassName("mt_opened")?"collapse":"expand"](a);return b},insertBranches:function(a,b){var c=this.getBranchById(b);if(a instanceof String||typeof a=="string"){c.innerHTML=a;this._formatUL(c)}else{var e=this._createNode(c);a.each(function(d){this._insertBranch(d,e);d.children&&d.children.length>0&&this.insertBranches(d.children,d.id)}.bind(this))}},_insertBranch:function(a,b){a.id=this.prefix+a.id;
var c=this._createBranch(a);b.insert(c);return c},_formatUL:function(a){(a=$(a).down("ul"))&&a.childElements().each(function(b){b.id=this.prefix+b.id;b.addClassName("mt_closed");var c=b.firstChild.data;b.removeChild(b.firstChild);c=this._create_span(c);if(typeof b.down("ul")=="undefined")b.insert({top:c});else{b.down("ul").insert({before:c});this._formatUL(b)}}.bind(this))},_createNode:function(a){a=$(a);var b=a.down("ul");if(!b){b=(new Element("ul")).wrap(a);b=b.down("ul")}return b},_createBranch:function(a){var b=
new Element("li",{id:a.id,"class":"mt_closed"});a=this._create_span(a.label);b.insert({top:a});return b},_create_span:function(a){a=(new Element("span")).insert(a);a.insert({top:new Element("img",{src:this.options["img.path"]+this.options["img.mt_fopened"],"class":"mt_fopened",alt:""})});a.insert({top:new Element("img",{src:this.options["img.path"]+this.options["img.mt_fclosed"],"class":"mt_fclosed",alt:""})});a.insert({top:new Element("img",{src:this.options["img.path"]+this.options["img.mt_plus"],
"class":"mt_plus",alt:""})});a.insert({top:new Element("img",{src:this.options["img.path"]+this.options["img.mt_minus"],"class":"mt_minus",alt:""})});a.insert({top:new Element("img",{src:this.options["img.path"]+this.options["img.mt_none"],"class":"mt_none",alt:""})});return a},select:function(a){a=$(a);$$(".mt_selected").each(this.deselect.bind(this));a.addClassName("mt_selected");if(a.hasClassName("mt_leaf")){a.removeClassName("mt_closed");a.addClassName("mt_opened")}a.fire("maarch:tree:branchselect",
{branch_id:a.id.replace(RegExp(this.prefix+"(.*)"),"$1")});return a},deselect:function(a){a=$(a);a.removeClassName("mt_selected");if(a.hasClassName("mt_leaf")){a.removeClassName("mt_opened");a.addClassName("mt_closed")}return a},_setEventObserver:function(){this.root.on("click",".mt_plus, .mt_minus, span",function(a,b){var c=b.up("li");b.tagName=="SPAN"?this.select(c):this.toggle(c)}.bind(this))}}),activateToolTip:function(){var a=Maarch.treeview.Tree.prototype._createBranch;Maarch.treeview.Tree.addMethods({_createBranch:function(b){var c=
a.bind(this)(b);c.down("span").writeAttribute("title",b.toolTip||"");return c}})},activateAjaxLoad:function(a){var b=Maarch.treeview.Tree.prototype.expand;Maarch.treeview.Tree.addMethods({expand:function(c){var e=b.bind(this)(c);e.down("ul")||new Ajax.Request(a,{method:"post",parameters:{parent_id:e.id.replace(RegExp(this.prefix+"(.*)"),"$1")},onSuccess:function(d){eval("struct="+d.responseText+";");if(struct.length>0){this.insertBranches(struct,e.id);e.removeClassName("mt_leaf")}}.bind(this),onFailure:function(d){d=
"La branche n'a pas pu se charger correctement.<br/><small>(HTTP error "+d.status+" : "+a+")</small>";this.root.insert({top:(new Element("span",{id:"mt_error"})).update(d)});window.setTimeout(function(){$("mt_error").remove()},4E3)}.bind(this)});return e}})}};
